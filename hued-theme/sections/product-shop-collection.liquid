{% comment %} HUED REDESIGN: Shop the Collection Section {% endcomment %}
{% comment %}
  Displays other products from the same collection as the current product.
  - Shows 4 products
  - Excludes the current product
  - Uses the product's first collection
{% endcomment %}

{% assign current_collection = product.collections.first %}
{% assign products_to_show = 4 %}

{% if current_collection != blank and section.settings.show_section %}
  {% comment %} Count available products excluding current {% endcomment %}
  {% assign available_products = 0 %}
  {% for item in current_collection.products limit: 20 %}
    {% if item.id != product.id %}
      {% assign available_products = available_products | plus: 1 %}
    {% endif %}
  {% endfor %}

  {% if available_products > 0 %}
    <section
      class="shop-collection-section"
      data-section-id="{{ section.id }}"
      data-section-type="product-shop-collection"
    >
      <div class="page-wrapper">
        {% comment %} Header with title and View All link {% endcomment %}
        <div class="shop-collection__header">
          <h2 class="shop-collection__title">{{ section.settings.heading }}</h2>
          <a href="{{ current_collection.url }}" class="shop-collection__view-all">
            {{ section.settings.view_all_text }} <span class="shop-collection__arrow">&rarr;</span>
          </a>
        </div>

        {% comment %} Product Grid {% endcomment %}
        <div class="shop-collection__grid">
          {% assign product_count = 0 %}
          {% for item in current_collection.products %}
            {% if item.id != product.id and product_count < products_to_show %}
              {% assign product_count = product_count | plus: 1 %}
              <div class="shop-collection__item">
                <a href="{{ item.url }}" class="shop-collection__product-link">
                  <div class="shop-collection__image-wrapper">
                    {% if item.featured_image != blank %}
                      <img
                        src="{{ item.featured_image | image_url: width: 400 }}"
                        alt="{{ item.featured_image.alt | escape | default: item.title }}"
                        class="shop-collection__image"
                        width="400"
                        height="{{ 400 | divided_by: item.featured_image.aspect_ratio | round }}"
                        loading="lazy"
                      />
                      {% if item.media.size > 1 and settings.show_second_image_on_hover %}
                        <img
                          src="{{ item.media[1].preview_image | image_url: width: 400 }}"
                          alt="{{ item.media[1].alt | escape | default: item.title }}"
                          class="shop-collection__image shop-collection__image--hover"
                          width="400"
                          height="{{ 400 | divided_by: item.media[1].preview_image.aspect_ratio | round }}"
                          loading="lazy"
                        />
                      {% endif %}
                    {% else %}
                      <div class="shop-collection__placeholder">
                        {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                      </div>
                    {% endif %}
                  </div>
                  <div class="shop-collection__product-info">
                    <h3 class="shop-collection__product-title">{{ item.title }}</h3>
                    <div class="shop-collection__product-price">
                      {% if item.compare_at_price > item.price %}
                        <span class="shop-collection__price--sale">{{ item.price | money_without_trailing_zeros }}</span>
                        <span class="shop-collection__price--compare">{{ item.compare_at_price | money_without_trailing_zeros }}</span>
                      {% else %}
                        <span class="shop-collection__price">{{ item.price | money_without_trailing_zeros }}</span>
                      {% endif %}
                    </div>
                  </div>
                </a>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>
    </section>
  {% endif %}
{% endif %}

{% schema %}
{
  "name": {
    "en": "Shop the Collection"
  },
  "class": "section-shop-collection",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_section",
      "label": {
        "en": "Show section"
      },
      "default": true
    },
    {
      "type": "text",
      "id": "heading",
      "label": {
        "en": "Heading"
      },
      "default": "Shop the Collection"
    },
    {
      "type": "text",
      "id": "view_all_text",
      "label": {
        "en": "View all text"
      },
      "default": "VIEW ALL"
    }
  ],
  "templates": [
    "product"
  ]
}
{% endschema %}
