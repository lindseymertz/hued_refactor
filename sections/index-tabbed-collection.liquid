{{ 'section-collection.min.css' | asset_url | stylesheet_tag }}

{% comment %} Tabbed Collection Carousel - "Styles You'll Love" {% endcomment %}

<section
  class="tabbed-collection"
  data-section-id="{{ section.id }}"
  data-section-type="tabbed-collection"
>
  <div class="tabbed-collection__container">

    {% comment %} Header Row: Title + View All {% endcomment %}
    <div class="tabbed-collection__header">
      {% if section.settings.heading != blank %}
        <h2 class="tabbed-collection__title">{{ section.settings.heading | escape }}</h2>
      {% endif %}

      {% if section.settings.show_view_all and section.blocks.size > 0 %}
        {% assign first_block = section.blocks | first %}
        {% assign first_collection = collections[first_block.settings.collection] %}
        <a
          href="{{ first_collection.url | default: '/collections/all' }}"
          class="tabbed-collection__view-all"
          data-tabbed-view-all
        >
          View All
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M5 12h14"/>
            <path d="m12 5 7 7-7 7"/>
          </svg>
        </a>
      {% endif %}
    </div>

    {% comment %} Collection Tabs + Navigation Arrows {% endcomment %}
    {% if section.blocks.size > 0 %}
      <div class="tabbed-collection__tabs-row">
        <div class="tabbed-collection__tabs" role="tablist">
          {% for block in section.blocks %}
            {% assign collection = collections[block.settings.collection] %}
            {% assign tab_label = block.settings.tab_label | default: collection.title | default: 'Collection' %}
            <button
              class="tabbed-collection__tab{% if forloop.first %} is-active{% endif %}"
              data-tab-button="{{ forloop.index0 }}"
              data-collection-url="{{ collection.url | default: '/collections/all' }}"
              role="tab"
              aria-selected="{% if forloop.first %}true{% else %}false{% endif %}"
              {{ block.shopify_attributes }}
            >
              {{ tab_label | escape }}
            </button>
          {% endfor %}
        </div>

        {% comment %} Navigation Arrows {% endcomment %}
        <div class="tabbed-collection__nav">
          <button class="tabbed-collection__arrow tabbed-collection__arrow--prev" data-tabbed-prev aria-label="Previous products">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="m15 18-6-6 6-6"/>
            </svg>
          </button>
          <button class="tabbed-collection__arrow tabbed-collection__arrow--next" data-tabbed-next aria-label="Next products">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="m9 18 6-6-6-6"/>
            </svg>
          </button>
        </div>
      </div>
    {% endif %}

    {% comment %} Product Carousels (one per collection) {% endcomment %}
    <div class="tabbed-collection__content">
      {% for block in section.blocks %}
        {% assign collection = collections[block.settings.collection] %}

        <div
          class="tabbed-collection__panel{% if forloop.first %} is-active{% endif %}"
          data-tab-panel="{{ forloop.index0 }}"
          role="tabpanel"
          {% unless forloop.first %}hidden{% endunless %}
        >
          {% if collection != blank and collection.products.size > 0 %}
            <div class="tabbed-collection__carousel swiper-container" data-tabbed-swiper>
              <div class="swiper-wrapper">
                {% for product in collection.products limit: 12 %}
                  {% render 'product-item',
                    item: product,
                    grid: 'swiper-slide',
                    productsPerRow: 4,
                    image_default_width: '410x',
                    additionalInfo: true,
                    productInfoSetting: 'below',
                    isSearch: false
                  %}
                {% endfor %}
              </div>
            </div>
          {% else %}
            {% comment %} Onboarding/placeholder state {% endcomment %}
            <div class="tabbed-collection__carousel swiper-container" data-tabbed-swiper>
              <div class="swiper-wrapper">
                {% for i in (1..4) %}
                  <article class="swiper-slide product-item">
                    <div class="product-item__wrapper">
                      <div class="svg-placeholder">
                        {% capture placeholder %}product-{% cycle '1', '2', '3', '4' %}{% endcapture %}
                        {{ placeholder | placeholder_svg_tag }}
                      </div>
                      <div class="product-item-details">
                        <h3 class="product--item-title">{{ 'layout.onboarding.product_title' | t }}</h3>
                        <div class="product-item-price">
                          <span class="money">{{ 2999 | money }}</span>
                        </div>
                      </div>
                    </div>
                  </article>
                {% endfor %}
              </div>
            </div>
          {% endif %}
        </div>
      {% endfor %}

      {% comment %} Empty state when no blocks {% endcomment %}
      {% if section.blocks.size == 0 %}
        <div class="tabbed-collection__empty">
          <p>Add collection tabs in the theme editor to display products.</p>
        </div>
      {% endif %}
    </div>

  </div>
</section>

<script>
  (function() {
    var sectionId = '{{ section.id }}';
    var activeSwiper = null;

    function initTabbedCollection() {
      var section = document.querySelector('[data-section-id="' + sectionId + '"]');
      if (!section) return;

      // Check if already initialized
      if (section.dataset.initialized) return;
      section.dataset.initialized = 'true';

      var tabs = section.querySelectorAll('[data-tab-button]');
      var panels = section.querySelectorAll('[data-tab-panel]');
      var viewAllLink = section.querySelector('[data-tabbed-view-all]');
      var prevBtn = section.querySelector('[data-tabbed-prev]');
      var nextBtn = section.querySelector('[data-tabbed-next]');

      // Update arrow disabled states
      function updateArrowStates() {
        if (!activeSwiper || !prevBtn || !nextBtn) return;

        if (activeSwiper.isBeginning) {
          prevBtn.classList.add('is-disabled');
          prevBtn.setAttribute('disabled', '');
        } else {
          prevBtn.classList.remove('is-disabled');
          prevBtn.removeAttribute('disabled');
        }

        if (activeSwiper.isEnd) {
          nextBtn.classList.add('is-disabled');
          nextBtn.setAttribute('disabled', '');
        } else {
          nextBtn.classList.remove('is-disabled');
          nextBtn.removeAttribute('disabled');
        }
      }

      // Initialize Swiper for a container
      function initSwiper(container) {
        if (!container || container.swiper) {
          if (container && container.swiper) {
            activeSwiper = container.swiper;
            updateArrowStates();
          }
          return container ? container.swiper : null;
        }
        if (typeof Swiper === 'undefined') return null;

        var swiper = new Swiper(container, {
          slidesPerView: 2,
          slidesPerGroup: 1,
          spaceBetween: 16,
          watchOverflow: true,
          breakpoints: {
            500: {
              slidesPerView: 2,
              spaceBetween: 16
            },
            720: {
              slidesPerView: 3,
              spaceBetween: 20
            },
            1024: {
              slidesPerView: 4,
              spaceBetween: 24
            }
          },
          on: {
            slideChange: updateArrowStates,
            resize: updateArrowStates
          }
        });

        activeSwiper = swiper;
        updateArrowStates();
        return swiper;
      }

      // Header arrow click handlers
      if (prevBtn) {
        prevBtn.addEventListener('click', function() {
          if (activeSwiper) activeSwiper.slidePrev();
        });
      }

      if (nextBtn) {
        nextBtn.addEventListener('click', function() {
          if (activeSwiper) activeSwiper.slideNext();
        });
      }

      // Initialize swiper for active panel
      var activePanel = section.querySelector('.tabbed-collection__panel.is-active');
      if (activePanel) {
        var swiperContainer = activePanel.querySelector('[data-tabbed-swiper]');
        initSwiper(swiperContainer);
      }

      // Tab click handler
      tabs.forEach(function(tab) {
        tab.addEventListener('click', function() {
          var targetIndex = this.getAttribute('data-tab-button');
          var collectionUrl = this.getAttribute('data-collection-url');

          // Update active tab
          tabs.forEach(function(t) {
            t.classList.remove('is-active');
            t.setAttribute('aria-selected', 'false');
          });
          this.classList.add('is-active');
          this.setAttribute('aria-selected', 'true');

          // Update panels
          panels.forEach(function(panel) {
            var panelIndex = panel.getAttribute('data-tab-panel');
            if (panelIndex === targetIndex) {
              panel.classList.add('is-active');
              panel.removeAttribute('hidden');

              // Initialize swiper if not already done
              var swiperContainer = panel.querySelector('[data-tabbed-swiper]');
              initSwiper(swiperContainer);
            } else {
              panel.classList.remove('is-active');
              panel.setAttribute('hidden', '');
            }
          });

          // Update View All link
          if (viewAllLink && collectionUrl) {
            viewAllLink.setAttribute('href', collectionUrl);
          }
        });
      });
    }

    // Wait for Swiper to be available (theme.js loads lazily)
    function waitForSwiper() {
      if (typeof Swiper !== 'undefined') {
        initTabbedCollection();
      } else {
        // Poll for Swiper availability
        var attempts = 0;
        var maxAttempts = 50; // 5 seconds max
        var interval = setInterval(function() {
          attempts++;
          if (typeof Swiper !== 'undefined') {
            clearInterval(interval);
            initTabbedCollection();
          } else if (attempts >= maxAttempts) {
            clearInterval(interval);
            console.warn('Swiper not loaded for tabbed collection');
          }
        }, 100);
      }
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', waitForSwiper);
    } else {
      waitForSwiper();
    }

    // Also initialize on window load as fallback
    window.addEventListener('load', waitForSwiper);
  })();
</script>

{% schema %}
{
  "name": "Collection Carousel",
  "class": "section-tabbed-collection",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Styles You'll Love"
    },
    {
      "type": "checkbox",
      "id": "show_view_all",
      "label": "Show 'View All' link",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "collection_tab",
      "name": "Collection Tab",
      "limit": 6,
      "settings": [
        {
          "type": "collection",
          "id": "collection",
          "label": "Collection"
        },
        {
          "type": "text",
          "id": "tab_label",
          "label": "Custom tab label",
          "info": "Leave blank to use collection title"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Collection Carousel",
      "category": "Collection",
      "blocks": [
        {
          "type": "collection_tab"
        },
        {
          "type": "collection_tab"
        },
        {
          "type": "collection_tab"
        }
      ]
    }
  ],
  "templates": [
    "404",
    "article",
    "blog",
    "cart",
    "collection",
    "index",
    "list-collections",
    "page",
    "password",
    "product",
    "search"
  ]
}
{% endschema %}
