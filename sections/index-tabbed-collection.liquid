{{ 'section-collection.min.css' | asset_url | stylesheet_tag }}

{% comment %} Tabbed Collection Carousel - "Styles You'll Love" {% endcomment %}

<section
  class="tabbed-collection"
  data-section-id="{{ section.id }}"
  data-section-type="tabbed-collection"
>
  <div class="tabbed-collection__container">

    {% comment %} Header Row: Title + View All {% endcomment %}
    <div class="tabbed-collection__header">
      {% if section.settings.heading != blank %}
        <h2 class="tabbed-collection__title">{{ section.settings.heading | escape }}</h2>
      {% endif %}

      {% if section.settings.show_view_all and section.blocks.size > 0 %}
        {% assign first_block = section.blocks | first %}
        {% assign first_collection = collections[first_block.settings.collection] %}
        <a
          href="{{ first_collection.url | default: '/collections/all' }}"
          class="tabbed-collection__view-all"
          data-tabbed-view-all
        >
          View All
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M5 12h14"/>
            <path d="m12 5 7 7-7 7"/>
          </svg>
        </a>
      {% endif %}
    </div>

    {% comment %} Collection Tabs {% endcomment %}
    {% if section.blocks.size > 0 %}
      <div class="tabbed-collection__tabs" role="tablist">
        {% for block in section.blocks %}
          {% assign collection = collections[block.settings.collection] %}
          {% assign tab_label = block.settings.tab_label | default: collection.title | default: 'Collection' %}
          <button
            class="tabbed-collection__tab{% if forloop.first %} is-active{% endif %}"
            data-tab-button="{{ forloop.index0 }}"
            data-collection-url="{{ collection.url | default: '/collections/all' }}"
            role="tab"
            aria-selected="{% if forloop.first %}true{% else %}false{% endif %}"
            {{ block.shopify_attributes }}
          >
            {{ tab_label | escape }}
          </button>
        {% endfor %}
      </div>
    {% endif %}

    {% comment %} Product Carousels (one per collection) {% endcomment %}
    <div class="tabbed-collection__content">
      {% for block in section.blocks %}
        {% assign collection = collections[block.settings.collection] %}

        <div
          class="tabbed-collection__panel{% if forloop.first %} is-active{% endif %}"
          data-tab-panel="{{ forloop.index0 }}"
          role="tabpanel"
          {% unless forloop.first %}hidden{% endunless %}
        >
          {% if collection != blank and collection.products.size > 0 %}
            <div class="tabbed-collection__carousel swiper-container" data-tabbed-swiper>
              <div class="swiper-wrapper">
                {% for product in collection.products limit: 12 %}
                  {% render 'product-item',
                    item: product,
                    grid: 'swiper-slide',
                    productsPerRow: 4,
                    image_default_width: '410x',
                    additionalInfo: true,
                    productInfoSetting: 'below',
                    isSearch: false
                  %}
                {% endfor %}
              </div>

              {% comment %} Navigation Arrows {% endcomment %}
              <button class="tabbed-collection__arrow tabbed-collection__arrow--prev swiper-button-prev" aria-label="Previous products">
                {% render 'icon-arrow' %}
              </button>
              <button class="tabbed-collection__arrow tabbed-collection__arrow--next swiper-button-next" aria-label="Next products">
                {% render 'icon-arrow' %}
              </button>
            </div>
          {% else %}
            {% comment %} Onboarding/placeholder state {% endcomment %}
            <div class="tabbed-collection__carousel swiper-container" data-tabbed-swiper>
              <div class="swiper-wrapper">
                {% for i in (1..4) %}
                  <article class="swiper-slide product-item">
                    <div class="product-item__wrapper">
                      <div class="svg-placeholder">
                        {% capture placeholder %}product-{% cycle '1', '2', '3', '4' %}{% endcapture %}
                        {{ placeholder | placeholder_svg_tag }}
                      </div>
                      <div class="product-item-details">
                        <h3 class="product--item-title">{{ 'layout.onboarding.product_title' | t }}</h3>
                        <div class="product-item-price">
                          <span class="money">{{ 2999 | money }}</span>
                        </div>
                      </div>
                    </div>
                  </article>
                {% endfor %}
              </div>
              <button class="tabbed-collection__arrow tabbed-collection__arrow--prev swiper-button-prev" aria-label="Previous products">
                {% render 'icon-arrow' %}
              </button>
              <button class="tabbed-collection__arrow tabbed-collection__arrow--next swiper-button-next" aria-label="Next products">
                {% render 'icon-arrow' %}
              </button>
            </div>
          {% endif %}
        </div>
      {% endfor %}

      {% comment %} Empty state when no blocks {% endcomment %}
      {% if section.blocks.size == 0 %}
        <div class="tabbed-collection__empty">
          <p>Add collection tabs in the theme editor to display products.</p>
        </div>
      {% endif %}
    </div>

  </div>
</section>

<script>
  (function() {
    var section = document.querySelector('[data-section-id="{{ section.id }}"]');
    if (!section) return;

    var tabs = section.querySelectorAll('[data-tab-button]');
    var panels = section.querySelectorAll('[data-tab-panel]');
    var viewAllLink = section.querySelector('[data-tabbed-view-all]');
    var swipers = [];

    // Initialize Swiper for visible panel
    function initSwiper(container) {
      if (!container || container.swiper) return;

      return new Swiper(container, {
        slidesPerView: 2,
        slidesPerGroup: 1,
        spaceBetween: 16,
        navigation: {
          nextEl: container.querySelector('.swiper-button-next'),
          prevEl: container.querySelector('.swiper-button-prev')
        },
        breakpoints: {
          500: {
            slidesPerView: 2,
            spaceBetween: 16
          },
          720: {
            slidesPerView: 3,
            spaceBetween: 20
          },
          1024: {
            slidesPerView: 4,
            spaceBetween: 24
          }
        }
      });
    }

    // Initialize swiper for active panel
    var activePanel = section.querySelector('.tabbed-collection__panel.is-active');
    if (activePanel) {
      var swiperContainer = activePanel.querySelector('[data-tabbed-swiper]');
      initSwiper(swiperContainer);
    }

    // Tab click handler
    tabs.forEach(function(tab) {
      tab.addEventListener('click', function() {
        var targetIndex = this.getAttribute('data-tab-button');
        var collectionUrl = this.getAttribute('data-collection-url');

        // Update active tab
        tabs.forEach(function(t) {
          t.classList.remove('is-active');
          t.setAttribute('aria-selected', 'false');
        });
        this.classList.add('is-active');
        this.setAttribute('aria-selected', 'true');

        // Update panels
        panels.forEach(function(panel) {
          var panelIndex = panel.getAttribute('data-tab-panel');
          if (panelIndex === targetIndex) {
            panel.classList.add('is-active');
            panel.removeAttribute('hidden');

            // Initialize swiper if not already done
            var swiperContainer = panel.querySelector('[data-tabbed-swiper]');
            if (swiperContainer && !swiperContainer.swiper) {
              initSwiper(swiperContainer);
            } else if (swiperContainer && swiperContainer.swiper) {
              swiperContainer.swiper.update();
            }
          } else {
            panel.classList.remove('is-active');
            panel.setAttribute('hidden', '');
          }
        });

        // Update View All link
        if (viewAllLink && collectionUrl) {
          viewAllLink.setAttribute('href', collectionUrl);
        }
      });
    });
  })();
</script>

{% schema %}
{
  "name": "Collection Carousel",
  "class": "section-tabbed-collection",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Styles You'll Love"
    },
    {
      "type": "checkbox",
      "id": "show_view_all",
      "label": "Show 'View All' link",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "collection_tab",
      "name": "Collection Tab",
      "limit": 6,
      "settings": [
        {
          "type": "collection",
          "id": "collection",
          "label": "Collection"
        },
        {
          "type": "text",
          "id": "tab_label",
          "label": "Custom tab label",
          "info": "Leave blank to use collection title"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Collection Carousel",
      "category": "Collection",
      "blocks": [
        {
          "type": "collection_tab"
        },
        {
          "type": "collection_tab"
        },
        {
          "type": "collection_tab"
        }
      ]
    }
  ],
  "templates": [
    "404",
    "article",
    "blog",
    "cart",
    "collection",
    "index",
    "list-collections",
    "page",
    "password",
    "product",
    "search"
  ]
}
{% endschema %}
